angular.module("aggApp",["ngRoute","ngSanitize","ui.bootstrap"]).config(["$routeProvider","$locationProvider","$sceDelegateProvider",function(e,t,o){e.when("/",{templateUrl:"components/index.controller.html",controller:"indexCtrl",controllerAs:"vm"}).when("/posts/:id",{templateUrl:"posts/post.controller.html",controller:"postsCtrl",controllerAs:"vm"}).when("/users/:id",{templateUrl:"users/user.controller.html",controller:"usersCtrl",controllerAs:"vm"}).when("/users/:id/:idd",{templateUrl:"addPosts/addPosts.controller.html",controller:"addPostsCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"login/login.controller.html",controller:"loginCtrl",controllerAs:"vm"}).when("/register",{templateUrl:"register/register.controller.html",controller:"registerCtrl",controllerAs:"vm"}).when("/editProfile/:id",{templateUrl:"editProfile/editProfile.controller.html",controller:"editProfileCtrl",controllerAs:"vm"}).when("/editPost/:id",{templateUrl:"posts/editPost.controller.html",controller:"editPostCtrl",controllerAs:"vm"}).when("/db",{templateUrl:"dbt/dbt.controller.html",controller:"dbtCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/"}),t.html5Mode(!0),o.resourceUrlWhitelist(["self","https://www.youtube.com/**","https://www.mixcloud.com/**","https://www.soundcloud.com/**","https://w.soundcloud.com/**"])}]),function(){function e(e,t,o,s,n){var i=this;i.naslov="Laka",i.posts=[],i.pages=0,i.maxNaStran=10,i.lahkS=!0,t.rootUser&&n.getUserByID(t.rootUser._id).then(function(e){i.user=e.data}),s.getPosts().then(function(e){i.posts=[];var t=[];t=e.data,i.pages=t.length,i.strani=Math.ceil(i.pages/i.maxNaStran),i.trenStran=1;var o=i.pages,s=(i.trenStran-1)*i.maxNaStran,n=s+i.maxNaStran;i.trenStran*i.maxNaStran>o&&(n-=i.trenStran*i.maxNaStran-o);for(var r=s;r<n;r++)i.posts.push(t[r]),0;console.log(e),t=[]},function(e){console.error(e)}),n.getUsers().then(function(e){i.users=e.data,console.log(e)},function(e){console.error(e)}),i.modalOkno=function(){o.open({templateUrl:"/modalnaOkna/addPost/addPost.controller.html",controller:"addPostCtrl",controllerAs:"vm"}).result.catch(function(e){if(-1===["cancel","backdrop click","escape key press"].indexOf(e))throw e})},i.checkBtn=function(e){return-1==i.user.postReactions.indexOf(e)?"btn-circle btn-circle-default":"btn-circle btn-circle-success"},i.reactP=function(e){var t=i.user.postReactions.indexOf(e);-1==t?(i.user.postReactions.push(e),s.getPostByID(e).then(function(e){i.post=e.data,i.post.likes=i.post.likes+1,n.updateUser(i.user._id,i.user).then(function(e){s.editPost(i.post._id,i.post.title,i.post.owner,i.post.body,i.post.description,i.post.hashtags,i.post.likes,i.post.dislikes,i.post.comments).then(function(e){i.response="success"},function(e){console.error(e),i.response="errorPost"})},function(e){console.error(e),i.response="errorUser"})},function(e){console.error(e),i.response="errorPost"})):(i.user.postReactions.splice(t,1),s.getPostByID(e).then(function(e){i.post=e.data,i.post.likes=i.post.likes-1,n.updateUser(i.user._id,i.user).then(function(e){s.editPost(i.post._id,i.post.title,i.post.owner,i.post.body,i.post.description,i.post.hashtags,i.post.likes,i.post.dislikes,i.post.comments).then(function(e){i.response="success"},function(e){console.error(e),i.response="errorPost"})},function(e){console.error(e),i.response="errorUser"})},function(e){console.error(e),i.response="errorPost"}))},i.search=function(e){var r=i.searchStr,t=new RegExp("^(?=.{1,50}$)[a-žA-Ž0-9#( )]+$");if(""!=r&&null!=r){if(1==e&&t.test(r)){var a=i.searchStr.split(" ");s.getPosts().then(function(e){i.posts=[],i.postsTemp=e.data;for(var t=0;t<i.postsTemp.length;t++){if(0==r.toLowerCase().localeCompare(i.postsTemp[t].title.toLowerCase()))i.posts.push(i.postsTemp[t]);else for(var o=0;o<i.postsTemp[t].hashtags.length;o++)for(var s=0;s<a.length;s++){var n=a[s];"#"!=a[s].charAt(0)&&(n="#"+a[s]),n.toLowerCase()==i.postsTemp[t].hashtags[o].toLowerCase()&&(i.posts.push(i.postsTemp[t]),s=a.length,o=i.postsTemp[t].hashtags.length)}}console.log(e)},function(e){console.error(e)})}}else i.searchStr=void 0,i.newPage(0)},i.newPage=function(e){0<=e&&e<=i.strani&&e!=i.trenStran&&(0==e&&(e=1),i.trenStran=e,s.getPosts().then(function(e){var t=[];t=e.data,i.posts=[];var o=t.length,s=(i.trenStran-1)*i.maxNaStran,n=s+i.maxNaStran;i.trenStran*i.maxNaStran>o&&(n-=i.trenStran*i.maxNaStran-o);for(var r=s;r<n;r++)i.posts.push(t[r]),0;t=[],console.log(e)},function(e){console.error(e)}))}}e.$inject=["$scope","$rootScope","$uibModal","aggAppPosts","aggAppUsers"],angular.module("aggApp").controller("indexCtrl",e)}(),angular.module("aggApp").directive("glava",function(){return{restrict:"EA",templateUrl:"/layout/glava/glava.controller.html"}}),function(){function e(e,t,s,o,n,r){var a=this;a.postID=t.id,a.adUs=!1,s.getPostByID(a.postID).then(function(e){a.post=e.data,o.getUsers().then(function(e){a.users=e.data,console.log(e)},function(e){console.error(e)}),console.log(e)},function(e){console.error(e)}),r.rootUser&&n.getUserIdentityByID(r.rootUser.identity).then(function(e){console.log("break"),console.log(e.data),"admin"==e.data.userType&&(console.log("add"),a.adUs=!0)},function(e){console.error(e)}),a.dodajComment=function(e){a.desRes=!1;var t={owner:e._id,content:a.comment},o=new RegExp("^(?=.{1,500}$)[a-žA-Ž0-9#-.!?( )]+$");t.content&&o.test(t.content)?(a.post.comments.push(t),s.addComm(a.postID,a.post.title,a.post.owner,a.post.body,a.post.description,a.post.hashtags,a.post.likes,a.post.dislikes,a.post.comments).then(function(e){a.desRes="success",a.comment="",console.log(e)},function(e){console.error(e),a.desRes="err"})):a.desRes="true"},a.izbrisiPost=function(e){o.getUserByID(a.post.owner).then(function(e){a.user=e.data;var t=a.user.posts.indexOf(a.postID);-1!=t?(a.user.posts.splice(t,1),s.deletePost(a.post._id).then(function(e){o.updateUser(a.user._id,a.user).then(function(e){a.response="success"},function(e){console.error(e),a.response="errorUser"})},function(e){console.error(e),a.response="error"})):console.log("tuu")},function(e){console.error(e),a.response="errorUser"})}}e.$inject=["$scope","$routeParams","aggAppPosts","aggAppUsers","aggAppUsersIdentity","$rootScope"],angular.module("aggApp").controller("postsCtrl",e)}(),function(){function e(c,p){return{getUsers:function(){return c.get("/api/users",{headers:{Authorization:"Bearer "+p.getToken()}})},getUserByID:function(e){return c.get("/api/users/"+e,{headers:{Authorization:"Bearer "+p.getToken()}})},updateUser:function(e,t){return c.put("/api/users/"+e,t,{headers:{Authorization:"Bearer "+p.getToken()}})},postUser:function(e,t,o,s,n,r,a,i,l,u){return c.post("/api/users/",{identity:e,username:t,name:o,surname:s,profilePicture:n,posts:r,postReactions:a,points:i,dateJoined:l,dateLastActive:u},{headers:{Authorization:"Bearer "+p.getToken()}})}}}e.$inject=["$http","auth"],angular.module("aggApp").service("aggAppUsers",e)}(),function(){function e(e,t,o,s,n,r,a){var i=this;i.userID=t.id,r.getUserByID(i.userID).then(function(e){i.user=e.data;var t=e.data.posts;i.userPosts=new Array;for(var o=0;o<t.length;o++)n.getPostByID(t[o]).then(function(e){i.userPosts.push(e.data)},function(e){console.log(e)})},function(e){console.error(e)}),e.rootUser&&r.getUserByID(e.rootUser._id).then(function(e){i.userD=e.data}),i.checkBtn=function(e){return-1==i.userD.postReactions.indexOf(e)?"btn-circle btn-circle-default":"btn-circle btn-circle-success"},i.reactP=function(e){var t=i.userD.postReactions.indexOf(e);-1==t?(i.userD.postReactions.push(e),n.getPostByID(e).then(function(e){i.post=e.data,i.post.likes=i.post.likes+1,r.updateUser(i.userD._id,i.userD).then(function(e){n.editPost(i.post._id,i.post.title,i.post.owner,i.post.body,i.post.description,i.post.hashtags,i.post.likes,i.post.dislikes,i.post.comments).then(function(e){i.response="success"},function(e){console.error(e),i.response="errorPost"})},function(e){console.error(e),i.response="errorUser"})},function(e){console.error(e),i.response="errorPost"})):(i.userD.postReactions.splice(t,1),n.getPostByID(e).then(function(e){i.post=e.data,i.post.likes=i.post.likes-1,r.updateUser(i.userD._id,i.userD).then(function(e){n.editPost(i.post._id,i.post.title,i.post.owner,i.post.body,i.post.description,i.post.hashtags,i.post.likes,i.post.dislikes,i.post.comments).then(function(e){i.response="success"},function(e){console.error(e),i.response="errorPost"})},function(e){console.error(e),i.response="errorUser"})},function(e){console.error(e),i.response="errorPost"}))},i.logout=function(){e.rootUser=null,a.logout(),o.path("/"),s.reload()}}e.$inject=["$rootScope","$routeParams","$location","$route","aggAppPosts","aggAppUsers","auth"],angular.module("aggApp").controller("usersCtrl",e)}(),function(){function e(o,s,e,n,r){var t=this,a=!(t.prijavniPodatki={email:"",password:""});t.login=function(){var e=new RegExp("^(?![.])(?!.*[.]{2})[a-zA-Z0-9.!#$%&'*+-/=?^_`{|}~]+(?<![.])@(?![-])[a-zA-Z0-9-]+(?<![-]).(?![.])(?!.*[.]{2})[a-zA-Z0-9.]+(?<![.])$");new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.{8,})(?![s])").test(t.prijavniPodatki.password)&&e.test(t.prijavniPodatki.email)&&r.login(t.prijavniPodatki).then(function(e){var t=r.currentUser();t?n.getUserByID(t._id).then(function(e){o.rootUser=e.data,a=!0,console.log("Nastavil uporabnika v root scope---------------"),console.log(e.data),s.path("/")},function(e){console.error(e)}):console.log("NI PRIJAVLJENEGA UPORABNIKA!")},function(e){t.napakaNaObrazcu=e.data.sporocilo}),a||(t.response="failure")}}e.$inject=["$rootScope","$location","aggAppUsersIdentity","aggAppUsers","auth"],angular.module("aggApp").controller("loginCtrl",e)}(),function(){function e(e,n,r){var a=this;a.prijavniPodatki={name:"",surname:"",username:"",email:"",password:"",password2:"",profilePic:""},a.prvotnaStran="/",a.register=function(){var e=new RegExp("^(?=.{4,20}$)[a-žA-Ž0-9-()]+$"),t=new RegExp("^(?![.])(?!.*[.]{2})[a-zA-Z0-9.!#$%&'*+-/=?^_`{|}~]+(?<![.])@(?![-])[a-zA-Z0-9-]+(?<![-]).(?![.])(?!.*[.]{2})[a-zA-Z0-9.]+(?<![.])$"),o=new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.{8,})(?![s])"),s=new RegExp("^(?=.{1,50}$)(?![ ])[a-žA-Ž-( )]+(?<![ ])$");e.test(a.prijavniPodatki.username)||(a.usernameRes="true"),t.test(a.prijavniPodatki.email)||(a.emailRes="true"),o.test(a.prijavniPodatki.password)?a.prijavniPodatki.password!=a.prijavniPodatki.password2&&(a.pass2Res="true"):a.passRes="true",s.test(a.prijavniPodatki.name)||(a.nameRes="true"),s.test(a.prijavniPodatki.surname)||(a.surnameRes="true"),0==0&&r.registration(a.prijavniPodatki).then(function(e){n.search("stran",null),n.path(a.prvotnaStran)},function(e){a.napakaNaObrazcu=e.data.sporocilo})}}e.$inject=["$rootScope","$location","auth"],angular.module("aggApp").controller("registerCtrl",e)}(),function(){function e(s,n){return{getUsersIdentity:function(){return s.get("/api/userIdentities",{headers:{Authorization:"Bearer "+n.getToken()}})},getUserIdentityByID:function(e){return s.get("/api/userIdentities/"+e,{headers:{Authorization:"Bearer "+n.getToken()}})},postUserIdentity:function(e,t,o){return s.post("/api/userIdentities/",{email:e,password:t,userType:o},{headers:{Authorization:"Bearer "+n.getToken()}})},putUserIdentity:function(e,t,o){return s.put("/api/userIdentities/"+e,{email:t,password:o},{headers:{Authorization:"Bearer "+n.getToken()}})}}}e.$inject=["$http","auth"],angular.module("aggApp").service("aggAppUsersIdentity",e)}(),function(){function e(e){this.modalnoOkno={preklici:function(){e.close()}}}console.log("NOTER SEEEEM!"),e.$inject=["$uibModalInstance"],angular.module("aggApp").controller("addPostCtrl",e)}(),function(){function e(e,t,n,r){var a=this;a.userID=t.id,a.typeID=t.idd,a.title="",a.url="",a.description="",a.tags="",a.dodajPost=function(){var e;if(3==a.typeID)e={bodyType:"text",content:""};else if(1==a.typeID)e={bodyType:"image",content:a.url};else{var t;null!=(t=-1!==a.url.indexOf("youtube.com/watch?v=")?a.url.substr(a.url.indexOf("youtube.com/watch?v=")+20):-1!==a.url.indexOf("youtube.com/watch/?v=")?a.url.substr(a.url.indexOf("youtube.com/watch/?v=")+21):-1!==a.url.indexOf("youtu.be")?a.url.substr(a.url.indexOf("youtu.be")+9):-1!==a.url.indexOf("www.youtube.com/embed/")?a.url.substr(a.url.indexOf("www.youtube.com/embed/")+22):-1!==a.url.indexOf("?v=")?a.url.substr(a.url.indexOf("?v=")+3,11):(console.warn("YouTubeUrlNormalize getVidId not a youTube Video: "+a.url),null))&&(-1!==t.indexOf("&")&&(t=t.substr(0,t.indexOf("&"))),null!=t&&(a.url="https://www.youtube.com/embed/"+t)),e={bodyType:"embed",content:a.url}}a.titleRes="false",a.urlRes="false",a.desRes="false",a.tagsRes="false";var o=0;new RegExp("^(#[a-žA-Ž0-9]+( )?)+$").test(a.tags)||(o=1,a.tagsRes="true"),new RegExp("^(?=.{1,500}$)[a-žA-Ž0-9#-.!?( )]+$").test(a.description)||(o=1,a.desRes="true");var s=new RegExp("^(http://www.|https://www.|http://|https://)?[a-z0-9]+([-.]{1}[a-z0-9]+)*.[a-z]{2,5}(:[0-9]{1,5})?(/.*)?$");a.typeID3&&!s.test(a.url)&&(o=1,a.urlRes="true"),new RegExp("^(?=.{1,20}$)[a-žA-Ž0-9( )]+$").test(a.title)||(o=1,a.titleRes="true"),0==o&&(a.tags=a.tags.split(" "),n.addPost(a.title,a.userID,e,a.description,a.tags,0,0,{}).then(function(t){r.getUserByID(a.userID).then(function(e){console.log(e),e.data.posts.push(t.data._id),r.updateUser(a.userID,e.data).then(function(e){a.response="success",a.title=void 0,a.url=void 0,a.description=void 0,a.tags=void 0,console.log(e)},function(e){a.response="errorUpdate",console.log(e)})},function(e){console.log(e),a.response="errorGet"}),console.log(t)},function(e){console.error(e),a.response="errorAdd"}))}}e.$inject=["$rootScope","$routeParams","aggAppPosts","aggAppUsers"],angular.module("aggApp").controller("addPostsCtrl",e)}(),function(){function e(i,e,l,t,s,u,c){var p=this;p.userID=e.id,console.log(i.rootUser),u.getUserByID(p.userID).then(function(e){p.user=e.data;var t=e.data.posts;p.userPosts=new Array;for(var o=0;o<t.length;o++)s.getPostByID(t[o]).then(function(e){p.userPosts.push(e.data)},function(e){console.log(e)})},function(e){console.error(e)}),p.editP=function(e){var t=new RegExp("^(?=.{4,20}$)[a-žA-Ž0-9-( )]+$"),o=new RegExp("^(?![.])(?!.*[.]{2})[a-zA-Z0-9.!#$%&'*+-/=?^_`{|}~]+(?<![.])@(?![-])[a-zA-Z0-9-]+(?<![-]).(?![.])(?!.*[.]{2})[a-zA-Z0-9.]+(?<![.])$"),s=new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.{8,})(?![s])"),n=new RegExp("^(?=.{1,50}$)(?![ ])[a-žA-Ž-( )]+(?<![ ])$");p.usernameRes="false",p.emailRes="false",p.passRes="false",p.pass2Res="false",p.nameRes="false",p.surnameRes="false",p.response="false",p.noviUser={posts:p.user.posts,postReactions:p.user.postReactions,points:p.user.points,_id:p.user._id,identity:p.user.identity,username:p.novUsername,name:p.novName,surname:p.novSurname,profilePicture:p.url,dateLastActive:p.user.dateLastActive},p.noviIdentity={_id:p.noviUser.identity,email:p.novEmail,password:p.novPassword},c.getUsersIdentity().then(function(e){console.log("break"),console.log(e.data)},function(e){console.error(e)});var r=new RegExp("^(http://www.|https://www.|http://|https://)?[a-z0-9]+([-.]{1}[a-z0-9]+)*.[a-z]{2,5}(:[0-9]{1,5})?(/.*)?$"),a=0;p.novUsername&&p.novName&&p.novSurname&&p.noviIdentity.email&&p.noviIdentity.password?(p.url?r.test(p.url)&&(a=1):p.noviUser.profilePicture=p.user.profilePicture,t.test(p.novUsername)||(p.usernameRes="true",a=1),o.test(p.noviIdentity.email)||(p.emailRes="true",a=1),s.test(p.noviIdentity.password)?p.noviIdentity.password!=p.novPassword2&&(p.pass2Res="true",a=1):(p.passRes="true",a=1),n.test(p.novName)||(p.nameRes="true",a=1),n.test(p.novSurname)||(p.surnameRes="true",a=1),0==a&&u.updateUser(p.noviUser._id,p.noviUser).then(function(e){c.putUserIdentity(p.noviIdentity._id,p.noviIdentity.email,p.noviIdentity.password).then(function(e){console.log(e),u.getUserByID(p.noviUser._id).then(function(e){i.rootUser=e.data,console.log("Nastavil uporabnika v root scope---------------"),console.log(e.data),l.path("/")},function(e){console.error(e)})},function(e){console.error(e),p.response="errorAdd"}),p.response="success",console.log(e)},function(e){console.error(e),p.response="errorAdd"})):p.response="brezp"}}e.$inject=["$rootScope","$routeParams","$location","$route","aggAppPosts","aggAppUsers","aggAppUsersIdentity"],angular.module("aggApp").controller("editProfileCtrl",e)}(),function(){function e(e,t,o,s){var n=this;n.postID=t.id,o.getPostByID(n.postID).then(function(e){n.post=e.data,s.getUsers().then(function(e){n.users=e.data,console.log(e)},function(e){console.error(e)}),console.log(e)},function(e){console.error(e)}),n.editPo=function(){if(n.novDescription&&n.novTags){var e=0;new RegExp("^(#[a-žA-Ž0-9]+( )?)+$").test(n.novTags)||(e=1,n.tagsRes="true"),n.novTags=n.novTags.split(" "),new RegExp("^(?=.{1,500}$)[a-žA-Ž0-9#-.!?( )]+$").test(n.novDescription)||(e=1,n.desRes="true"),0==e&&o.editPost(n.post._id,n.post.title,n.post.owner,n.post.body,n.novDescription,n.novTags,n.post.likes,n.post.dislikes,n.post.comments).then(function(e){n.response="success",console.log(e)},function(e){console.error(e),n.response="errorAdd"})}else n.response="brezp"}}e.$inject=["$scope","$routeParams","aggAppPosts","aggAppUsers"],angular.module("aggApp").controller("editPostCtrl",e)}(),function(){function e(u,c){return{getPosts:function(){return u.get("/api/posts")},getPostByID:function(e){return u.get("/api/posts/"+e)},addPost:function(e,t,o,s,n,r,a,i){return u.post("/api/posts",{title:e,owner:t,body:o,description:s,hashtags:n,likes:r,dislikes:a,comments:i},{headers:{Authorization:"Bearer "+c.getToken()}})},addComm:function(e,t,o,s,n,r,a,i,l){return u.put("/api/posts/"+e,{title:t,owner:o,body:s,description:n,hashtags:r,likes:a,dislikes:i,comments:l},{headers:{Authorization:"Bearer "+c.getToken()}})},editPost:function(e,t,o,s,n,r,a,i,l){return u.put("/api/posts/"+e,{title:t,owner:o,body:s,description:n,hashtags:r,likes:a,dislikes:i,comments:l},{headers:{Authorization:"Bearer "+c.getToken()}})},deletePost:function(e){return u.delete("/api/posts/"+e,{headers:{Authorization:"Bearer "+c.getToken()}})}}}e.$inject=["$http","auth"],angular.module("aggApp").service("aggAppPosts",e)}(),function(){function e(o,t){var s=function(e){o.localStorage["Aggregate-token"]=e},n=function(){return o.localStorage["Aggregate-token"]},r=function(){var e=n();return!!e&&JSON.parse(o.atob(e.split(".")[1])).datumPoteka>Date.now()/1e3};return{saveToken:s,getToken:n,registration:function(e){return t.post("/api/registracija",e).then(function(e){console.log("Shranim zeton"),console.log(e.data.zeton),s(e.data.zeton)})},login:function(e){return t.post("/api/prijava",e).then(function(e){s(e.data.zeton)})},logout:function(){o.localStorage.removeItem("Aggregate-token")},isLoggedIn:r,currentUser:function(){if(r()){var e=n(),t=JSON.parse(o.atob(e.split(".")[1]));return{_id:t._id,identity:t.identity}}}}}e.$inject=["$window","$http"],angular.module("aggApp").service("auth",e)}(),function(){function e(e){var t=this;t.responseD="",t.responseI="",t.init=function(){t.responseD="",t.responseI="",console.log("init"),e.get("/api/db/init").then(function(e){t.responseI="success"},function(e){t.responseI="error",console.error(e)})},t.drop=function(){t.responseD="",t.responseI="",console.log("drop"),e.get("/api/db/drop").then(function(e){t.responseD="success"},function(e){t.responseD="error",console.error(e)})}}e.$inject=["$http"],angular.module("aggApp").controller("dbtCtrl",e)}();