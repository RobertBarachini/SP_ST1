angular.module("aggApp",["ngRoute","ngSanitize","ui.bootstrap"]).config(["$routeProvider","$locationProvider","$sceDelegateProvider",function(e,t,o){e.when("/",{templateUrl:"components/index.controller.html",controller:"indexCtrl",controllerAs:"vm"}).when("/posts/:id",{templateUrl:"posts/post.controller.html",controller:"postsCtrl",controllerAs:"vm"}).when("/users/:id",{templateUrl:"users/user.controller.html",controller:"usersCtrl",controllerAs:"vm"}).when("/users/:id/:idd",{templateUrl:"addPosts/addPosts.controller.html",controller:"addPostsCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"login/login.controller.html",controller:"loginCtrl",controllerAs:"vm"}).when("/register",{templateUrl:"register/register.controller.html",controller:"registerCtrl",controllerAs:"vm"}).when("/editProfile/:id",{templateUrl:"editProfile/editProfile.controller.html",controller:"editProfileCtrl",controllerAs:"vm"}).when("/editPost/:id",{templateUrl:"posts/editPost.controller.html",controller:"editPostCtrl",controllerAs:"vm"}).when("/db",{templateUrl:"dbt/dbt.controller.html",controller:"dbtCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/"}),t.html5Mode(!0),o.resourceUrlWhitelist(["self","https://www.youtube.com/**","https://www.mixcloud.com/**","https://www.soundcloud.com/**","https://w.soundcloud.com/**"])}]),function(){function e(e,t,o,s,r){var a=this;a.naslov="Laka",a.posts=[],a.pages=0,a.maxNaStran=10,a.lahkS=!0,t.rootUser&&r.getUserByID(t.rootUser._id).then(function(e){a.user=e.data}),s.getPosts().then(function(e){a.posts=[];var t=[];t=e.data,a.pages=t.length,a.strani=Math.ceil(a.pages/a.maxNaStran),a.trenStran=1;var o=a.pages,s=(a.trenStran-1)*a.maxNaStran,r=s+a.maxNaStran;a.trenStran*a.maxNaStran>o&&(r-=a.trenStran*a.maxNaStran-o);for(var n=s;n<r;n++)a.posts.push(t[n]),0;console.log(e),t=[]},function(e){console.error(e)}),r.getUsers().then(function(e){a.users=e.data,console.log(e)},function(e){console.error(e)}),a.modalOkno=function(){o.open({templateUrl:"/modalnaOkna/addPost/addPost.controller.html",controller:"addPostCtrl",controllerAs:"vm"}).result.catch(function(e){if(-1===["cancel","backdrop click","escape key press"].indexOf(e))throw e})},a.checkBtn=function(e){return-1==a.user.postReactions.indexOf(e)?"btn-circle btn-circle-default":"btn-circle btn-circle-success"},a.reactP=function(e){var t=a.user.postReactions.indexOf(e);-1==t?(a.user.postReactions.push(e),s.getPostByID(e).then(function(e){a.post=e.data,a.post.likes=a.post.likes+1,r.updateUser(a.user._id,a.user).then(function(e){s.editPost(a.post._id,a.post.title,a.post.owner,a.post.body,a.post.description,a.post.hashtags,a.post.likes,a.post.dislikes,a.post.comments).then(function(e){a.response="success"},function(e){console.error(e),a.response="errorPost"})},function(e){console.error(e),a.response="errorUser"})},function(e){console.error(e),a.response="errorPost"})):(a.user.postReactions.splice(t,1),s.getPostByID(e).then(function(e){a.post=e.data,a.post.likes=a.post.likes-1,r.updateUser(a.user._id,a.user).then(function(e){s.editPost(a.post._id,a.post.title,a.post.owner,a.post.body,a.post.description,a.post.hashtags,a.post.likes,a.post.dislikes,a.post.comments).then(function(e){a.response="success"},function(e){console.error(e),a.response="errorPost"})},function(e){console.error(e),a.response="errorUser"})},function(e){console.error(e),a.response="errorPost"}))},a.search=function(e){var n=a.searchStr,t=new RegExp("^(?=.{1,50}$)[a-žA-Ž0-9#( )]+$");if(""!=n&&null!=n){if(1==e&&t.test(n)){var i=a.searchStr.split(" ");s.getPosts().then(function(e){a.posts=[],a.postsTemp=e.data;for(var t=0;t<a.postsTemp.length;t++){if(0==n.toLowerCase().localeCompare(a.postsTemp[t].title.toLowerCase()))a.posts.push(a.postsTemp[t]);else for(var o=0;o<a.postsTemp[t].hashtags.length;o++)for(var s=0;s<i.length;s++){var r=i[s];"#"!=i[s].charAt(0)&&(r="#"+i[s]),r.toLowerCase()==a.postsTemp[t].hashtags[o].toLowerCase()&&(a.posts.push(a.postsTemp[t]),s=i.length,o=a.postsTemp[t].hashtags.length)}}console.log(e)},function(e){console.error(e)})}}else a.searchStr=void 0,a.newPage(0)},a.newPage=function(e){0<=e&&e<=a.strani&&e!=a.trenStran&&(0==e&&(e=1),a.trenStran=e,s.getPosts().then(function(e){var t=[];t=e.data,a.posts=[];var o=t.length,s=(a.trenStran-1)*a.maxNaStran,r=s+a.maxNaStran;a.trenStran*a.maxNaStran>o&&(r-=a.trenStran*a.maxNaStran-o);for(var n=s;n<r;n++)a.posts.push(t[n]),0;t=[],console.log(e)},function(e){console.error(e)}))}}e.$inject=["$scope","$rootScope","$uibModal","aggAppPosts","aggAppUsers"],angular.module("aggApp").controller("indexCtrl",e)}(),angular.module("aggApp").directive("glava",function(){return{restrict:"EA",templateUrl:"/layout/glava/glava.controller.html"}}),function(){function e(e,t,s,o,r,n){var i=this;i.postID=t.id,i.adUs=!1,s.getPostByID(i.postID).then(function(e){i.post=e.data,o.getUsers().then(function(e){i.users=e.data,console.log(e)},function(e){console.error(e)}),console.log(e)},function(e){console.error(e)}),n.rootUser&&r.getUserIdentityByID(n.rootUser.identity).then(function(e){console.log("break"),console.log(e.data),"admin"==e.data.userType&&(console.log("add"),i.adUs=!0)},function(e){console.error(e)}),i.dodajComment=function(e){i.desRes=!1;var t={owner:e._id,content:i.comment},o=new RegExp("^(?=.{1,500}$)[a-žA-Ž0-9#-.!?( )]+$");t.content&&o.test(t.content)?(i.post.comments.push(t),s.addComm(i.postID,i.post.title,i.post.owner,i.post.body,i.post.description,i.post.hashtags,i.post.likes,i.post.dislikes,i.post.comments).then(function(e){i.desRes="success",i.comment="",console.log(e)},function(e){console.error(e),i.desRes="err"})):i.desRes="true"},i.izbrisiPost=function(e){o.getUserByID(i.post.owner).then(function(e){i.user=e.data;var t=i.user.posts.indexOf(i.postID);-1!=t?(i.user.posts.splice(t,1),s.deletePost(i.post._id).then(function(e){o.updateUser(i.user._id,i.user).then(function(e){i.response="success"},function(e){console.error(e),i.response="errorUser"})},function(e){console.error(e),i.response="error"})):console.log("tuu")},function(e){console.error(e),i.response="errorUser"})}}e.$inject=["$scope","$routeParams","aggAppPosts","aggAppUsers","aggAppUsersIdentity","$rootScope"],angular.module("aggApp").controller("postsCtrl",e)}(),function(){function e(c,p){return{getUsers:function(){return c.get("/api/users",{headers:{Authorization:"Bearer "+p.getToken()}})},getUserByID:function(e){return c.get("/api/users/"+e,{headers:{Authorization:"Bearer "+p.getToken()}})},updateUser:function(e,t){return c.put("/api/users/"+e,t,{headers:{Authorization:"Bearer "+p.getToken()}})},postUser:function(e,t,o,s,r,n,i,a,l,u){return c.post("/api/users/",{identity:e,username:t,name:o,surname:s,profilePicture:r,posts:n,postReactions:i,points:a,dateJoined:l,dateLastActive:u},{headers:{Authorization:"Bearer "+p.getToken()}})}}}e.$inject=["$http","auth"],angular.module("aggApp").service("aggAppUsers",e)}(),function(){function e(o,e,t,s,r,n,i){var a=this;a.userID=e.id,n.getUserByID(a.userID).then(function(e){a.user=e.data;var t=e.data.posts;a.userPosts=new Array;for(var o=0;o<t.length;o++)r.getPostByID(t[o]).then(function(e){a.userPosts.push(e.data)},function(e){console.log(e)})},function(e){console.error(e)}),a.checkBtn=function(e){return-1==o.rootUser.postReactions.indexOf(e)?"btn-circle btn-circle-default":"btn-circle btn-circle-success"},a.reactP=function(e){var t=o.rootUser.postReactions.indexOf(e);-1==t?(a.user=o.rootUser,a.user.postReactions.push(e),r.getPostByID(e).then(function(e){a.post=e.data,a.post.likes=a.post.likes+1,n.updateUser(a.user._id,a.user).then(function(e){r.editPost(a.post._id,a.post.title,a.post.owner,a.post.body,a.post.description,a.post.hashtags,a.post.likes,a.post.dislikes,a.post.comments).then(function(e){a.response="success"},function(e){console.error(e),a.response="errorPost"})},function(e){console.error(e),a.response="errorUser"})},function(e){console.error(e),a.response="errorPost"})):(a.user=o.rootUser,a.user.postReactions.splice(t,1),r.getPostByID(e).then(function(e){a.post=e.data,a.post.likes=a.post.likes-1,n.updateUser(a.user._id,a.user).then(function(e){r.editPost(a.post._id,a.post.title,a.post.owner,a.post.body,a.post.description,a.post.hashtags,a.post.likes,a.post.dislikes,a.post.comments).then(function(e){a.response="success"},function(e){console.error(e),a.response="errorPost"})},function(e){console.error(e),a.response="errorUser"})},function(e){console.error(e),a.response="errorPost"}))},a.logout=function(){o.rootUser=null,i.logout(),t.path("/"),s.reload()}}e.$inject=["$rootScope","$routeParams","$location","$route","aggAppPosts","aggAppUsers","auth"],angular.module("aggApp").controller("usersCtrl",e)}(),function(){function e(o,s,e,r,n){var t=this,i=!(t.prijavniPodatki={email:"",password:""});t.login=function(){n.login(t.prijavniPodatki).then(function(e){var t=n.currentUser();t?r.getUserByID(t._id).then(function(e){o.rootUser=e.data,i=!0,console.log("Nastavil uporabnika v root scope---------------"),console.log(e.data),s.path("/")},function(e){console.error(e)}):console.log("NI PRIJAVLJENEGA UPORABNIKA!")},function(e){t.napakaNaObrazcu=e.data.sporocilo}),i||(t.response="failure")}}e.$inject=["$rootScope","$location","aggAppUsersIdentity","aggAppUsers","auth"],angular.module("aggApp").controller("loginCtrl",e)}(),function(){function e(e,t,o){var s=this;s.prijavniPodatki={name:"",surname:"",username:"",email:"",password:"",password2:"",profilePic:""},s.prvotnaStran="/",s.register=function(){o.registration(s.prijavniPodatki).then(function(e){t.search("stran",null),t.path(s.prvotnaStran)},function(e){s.napakaNaObrazcu=e.data.sporocilo})}}e.$inject=["$rootScope","$location","auth"],angular.module("aggApp").controller("registerCtrl",e)}(),function(){function e(s,r){return{getUsersIdentity:function(){return s.get("/api/userIdentities",{headers:{Authorization:"Bearer "+r.getToken()}})},getUserIdentityByID:function(e){return s.get("/api/userIdentities/"+e,{headers:{Authorization:"Bearer "+r.getToken()}})},postUserIdentity:function(e,t,o){return s.post("/api/userIdentities/",{email:e,password:t,userType:o},{headers:{Authorization:"Bearer "+r.getToken()}})},putUserIdentity:function(e,t,o){return s.put("/api/userIdentities/"+e,{email:t,password:o},{headers:{Authorization:"Bearer "+r.getToken()}})}}}e.$inject=["$http","auth"],angular.module("aggApp").service("aggAppUsersIdentity",e)}(),function(){function e(e){this.modalnoOkno={preklici:function(){e.close()}}}console.log("NOTER SEEEEM!"),e.$inject=["$uibModalInstance"],angular.module("aggApp").controller("addPostCtrl",e)}(),function(){function e(e,t,r,n){var i=this;i.userID=t.id,i.typeID=t.idd,i.title="",i.url="",i.description="",i.tags="",i.dodajPost=function(){var e;if(3==i.typeID)e={bodyType:"text",content:""};else if(1==i.typeID)e={bodyType:"image",content:i.url};else{var t;null!=(t=-1!==i.url.indexOf("youtube.com/watch?v=")?i.url.substr(i.url.indexOf("youtube.com/watch?v=")+20):-1!==i.url.indexOf("youtube.com/watch/?v=")?i.url.substr(i.url.indexOf("youtube.com/watch/?v=")+21):-1!==i.url.indexOf("youtu.be")?i.url.substr(i.url.indexOf("youtu.be")+9):-1!==i.url.indexOf("www.youtube.com/embed/")?i.url.substr(i.url.indexOf("www.youtube.com/embed/")+22):-1!==i.url.indexOf("?v=")?i.url.substr(i.url.indexOf("?v=")+3,11):(console.warn("YouTubeUrlNormalize getVidId not a youTube Video: "+i.url),null))&&(-1!==t.indexOf("&")&&(t=t.substr(0,t.indexOf("&"))),null!=t&&(i.url="https://www.youtube.com/embed/"+t)),e={bodyType:"embed",content:i.url}}i.titleRes="false",i.urlRes="false",i.desRes="false",i.tagsRes="false";var o=0;new RegExp("^(#[a-žA-Ž0-9]+( )?)+$").test(i.tags)||(o=1,i.tagsRes="true"),new RegExp("^(?=.{1,500}$)[a-žA-Ž0-9#-.!?( )]+$").test(i.description)||(o=1,i.desRes="true");var s=new RegExp("^(http://www.|https://www.|http://|https://)?[a-z0-9]+([-.]{1}[a-z0-9]+)*.[a-z]{2,5}(:[0-9]{1,5})?(/.*)?$");i.typeID3&&!s.test(i.url)&&(o=1,i.urlRes="true"),new RegExp("^(?=.{1,20}$)[a-žA-Ž0-9( )]+$").test(i.title)||(o=1,i.titleRes="true"),0==o&&(i.tags=i.tags.split(" "),r.addPost(i.title,i.userID,e,i.description,i.tags,0,0,{}).then(function(t){n.getUserByID(i.userID).then(function(e){console.log(e),e.data.posts.push(t.data._id),n.updateUser(i.userID,e.data).then(function(e){i.response="success",i.title=void 0,i.url=void 0,i.description=void 0,i.tags=void 0,console.log(e)},function(e){i.response="errorUpdate",console.log(e)})},function(e){console.log(e),i.response="errorGet"}),console.log(t)},function(e){console.error(e),i.response="errorAdd"}))}}e.$inject=["$rootScope","$routeParams","aggAppPosts","aggAppUsers"],angular.module("aggApp").controller("addPostsCtrl",e)}(),function(){function e(e,t,o,s,r,a,l){var u=this;u.userID=t.id,console.log(e.rootUser),a.getUserByID(u.userID).then(function(e){u.user=e.data;var t=e.data.posts;u.userPosts=new Array;for(var o=0;o<t.length;o++)r.getPostByID(t[o]).then(function(e){u.userPosts.push(e.data)},function(e){console.log(e)})},function(e){console.error(e)}),u.editP=function(e){var t=new RegExp("^(?=.{4,20}$)[a-žA-Ž0-9-( )]+$"),o=new RegExp("^(?![.])(?!.*[.]{2})[a-zA-Z0-9.!#$%&'*+-/=?^_`{|}~]+(?<![.])@(?![-])[a-zA-Z0-9-]+(?<![-]).(?![.])(?!.*[.]{2})[a-zA-Z0-9.]+(?<![.])$"),s=new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.{8,})(?![s])"),r=new RegExp("^(?=.{1,50}$)(?![ ])[a-žA-Ž-( )]+(?<![ ])$");u.usernameRes="false",u.emailRes="false",u.passRes="false",u.pass2Res="false",u.nameRes="false",u.surnameRes="false",u.response="false",u.noviUser={posts:u.user.posts,postReactions:u.user.postReactions,points:u.user.points,_id:u.user._id,identity:u.user.identity,username:u.novUsername,name:u.novName,surname:u.novSurname,profilePicture:u.url,dateLastActive:u.user.dateLastActive},u.noviIdentity={_id:u.noviUser.identity,email:u.novEmail,password:u.novPassword},l.getUsersIdentity().then(function(e){console.log("break"),console.log(e.data)},function(e){console.error(e)});var n=new RegExp("^(http://www.|https://www.|http://|https://)?[a-z0-9]+([-.]{1}[a-z0-9]+)*.[a-z]{2,5}(:[0-9]{1,5})?(/.*)?$"),i=0;u.novUsername&&u.novName&&u.novSurname&&u.noviIdentity.email&&u.noviIdentity.password?(u.url?n.test(u.url)&&(i=1):u.noviUser.profilePicture=u.user.profilePicture,t.test(u.novUsername)||(u.usernameRes="true",i=1),o.test(u.noviIdentity.email)||(u.emailRes="true",i=1),s.test(u.noviIdentity.password)?u.noviIdentity.password!=u.novPassword2&&(u.pass2Res="true",i=1):(u.passRes="true",i=1),r.test(u.novName)||(u.nameRes="true",i=1),r.test(u.novSurname)||(u.surnameRes="true",i=1),0==i&&a.updateUser(u.noviUser._id,u.noviUser).then(function(e){l.putUserIdentity(u.noviIdentity._id,u.noviIdentity.email,u.noviIdentity.password).then(function(e){},function(e){console.error(e),u.response="errorAdd"}),u.response="success",console.log(e)},function(e){console.error(e),u.response="errorAdd"})):u.response="brezp"}}e.$inject=["$rootScope","$routeParams","$location","$route","aggAppPosts","aggAppUsers","aggAppUsersIdentity"],angular.module("aggApp").controller("editProfileCtrl",e)}(),function(){function e(e,t,o,s){var r=this;r.postID=t.id,o.getPostByID(r.postID).then(function(e){r.post=e.data,s.getUsers().then(function(e){r.users=e.data,console.log(e)},function(e){console.error(e)}),console.log(e)},function(e){console.error(e)}),r.editPo=function(){if(r.novDescription&&r.novTags){var e=0;new RegExp("^(#[a-žA-Ž0-9]+( )?)+$").test(r.novTags)||(e=1,r.tagsRes="true"),r.novTags=r.novTags.split(" "),new RegExp("^(?=.{1,500}$)[a-žA-Ž0-9#-.!?( )]+$").test(r.novDescription)||(e=1,r.desRes="true"),0==e&&o.editPost(r.post._id,r.post.title,r.post.owner,r.post.body,r.novDescription,r.novTags,r.post.likes,r.post.dislikes,r.post.comments).then(function(e){r.response="success",console.log(e)},function(e){console.error(e),r.response="errorAdd"})}else r.response="brezp"}}e.$inject=["$scope","$routeParams","aggAppPosts","aggAppUsers"],angular.module("aggApp").controller("editPostCtrl",e)}(),function(){function e(u,c){return{getPosts:function(){return u.get("/api/posts")},getPostByID:function(e){return u.get("/api/posts/"+e)},addPost:function(e,t,o,s,r,n,i,a){return u.post("/api/posts",{title:e,owner:t,body:o,description:s,hashtags:r,likes:n,dislikes:i,comments:a},{headers:{Authorization:"Bearer "+c.getToken()}})},addComm:function(e,t,o,s,r,n,i,a,l){return u.put("/api/posts/"+e,{title:t,owner:o,body:s,description:r,hashtags:n,likes:i,dislikes:a,comments:l},{headers:{Authorization:"Bearer "+c.getToken()}})},editPost:function(e,t,o,s,r,n,i,a,l){return u.put("/api/posts/"+e,{title:t,owner:o,body:s,description:r,hashtags:n,likes:i,dislikes:a,comments:l},{headers:{Authorization:"Bearer "+c.getToken()}})},deletePost:function(e){return u.delete("/api/posts/"+e,{headers:{Authorization:"Bearer "+c.getToken()}})}}}e.$inject=["$http","auth"],angular.module("aggApp").service("aggAppPosts",e)}(),function(){function e(o,t){var s=function(e){o.localStorage["Aggregate-token"]=e},r=function(){return o.localStorage["Aggregate-token"]},n=function(){var e=r();return!!e&&JSON.parse(o.atob(e.split(".")[1])).datumPoteka>Date.now()/1e3};return{saveToken:s,getToken:r,registration:function(e){return t.post("/api/registracija",e).then(function(e){console.log("Shranim zeton"),console.log(e.data.zeton),s(e.data.zeton)})},login:function(e){return t.post("/api/prijava",e).then(function(e){s(e.data.zeton)})},logout:function(){o.localStorage.removeItem("Aggregate-token")},isLoggedIn:n,currentUser:function(){if(n()){var e=r(),t=JSON.parse(o.atob(e.split(".")[1]));return{_id:t._id,identity:t.identity}}}}}e.$inject=["$window","$http"],angular.module("aggApp").service("auth",e)}(),function(){function e(e){var t=this;t.responseD="",t.responseI="",t.init=function(){t.responseD="",t.responseI="",console.log("init"),e.get("/api/db/init").then(function(e){t.responseI="success"},function(e){t.responseI="error",console.error(e)})},t.drop=function(){t.responseD="",t.responseI="",console.log("drop"),e.get("/api/db/drop").then(function(e){t.responseD="success"},function(e){t.responseD="error",console.error(e)})}}e.$inject=["$http"],angular.module("aggApp").controller("dbtCtrl",e)}();